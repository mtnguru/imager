<?php

/**
 * @file
 * Provides full image viewing and editing capability from a page of thumbnails.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\user\UserInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;

/**
 * Implements hook_help().
 */
function imager_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the imager module.
    case 'help.page.imager':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Displays images at full resolution in a popup.  Users can pan, zoom, rotate, crop and change brightness/contrast and hue/saturation/lightness.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function imager_theme() {
  return array(
    'imager_formatter' => array(
      'variables' => array('item' => NULL, 'item_attributes' => NULL, 'url' => NULL, 'image_style' => NULL),
      'file' => 'imager.field.inc',
    ),
  );
}

/**
 * Implements hook_entity_presave().
 */
// function imager_entity_presave(EntityInterface $entity) {
//   return;
// }

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * FORM ID: media_image_form
 * Set default photographer to be the logged in user.
 */
function imager_form_media_image_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['field_photographer']['widget'][0]['target_id']['#default_value'] = \Drupal\user\Entity\User::load(\Drupal::currentUser()->id());
  $form['#submit'][] = 'imager_form_media_image_form_submit';
}

/**
 * 'media_image_form' submit function.
 *
 * If user did not set the image 'alt' field then set it from the Media name field.
 *
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 */
function imager_form_media_image_form_submit($form, FormStateInterface $form_state) {

  return;
}

/**
 * Implements hook_views_pre_view().
 *
 * Determine if this view needs imager module, if so set $_imager_enable = true.
 */
function imager_views_pre_view($view, $display_id, &$args) {
//global $_imager_enable;
//if (preg_match('/' . variable_get('imager_views_css_class') . '/',
//  $view->display['default']->display_options['css_class'])) {
//  if (!preg_match('/browser/', $view->name)) {
//    $_imager_enable = TRUE;
//  }
//}
}

/**
 * Implements hook_page_alter().
 *
 * If some other hook has enabled the Imager module, build the wrapper DIV
 * that will contain the Imager HTML.
 */
function imager_page_alter(array &$page) {
}

/**
 * Form constructor for the file edit form.
 *
 * @param array $form
 *   Form.
 * @param array $form_state
 *   Form state.
 *
 * @return array $form
 *   Return the form render array.
 */
function imager_file_entity_edit(array $form, array &$form_state) {
/*
  $form['#attributes']['class'][] = 'file-form';

  // Basic file information.
  // These elements are just values so they are not even sent to the client.
  foreach (array('fid', 'type', 'uid', 'timestamp') as $key) {
    $form[$key] = array(
      '#type' => 'value',
      // '#value' => isset($file->$key) ? $file->$key : NULL, .
    );
  }

  $form['filename'] = array(
    '#type' => 'textfield',
    '#title' => t('Name'),
    // '#default_value' => $file->filename, .
    '#required' => TRUE,
    '#maxlength' => 255,
    '#weight' => -10,
  );

  // $form['preview'] = file_view_file($file, 'preview'); .
  $form['additional_settings'] = array(
    '#type' => 'vertical_tabs',
    '#weight' => 99,
  );

  // File destination information for administrators.
  $form['destination'] = array(
    '#type' => 'fieldset',
    '#title' => t('Destination'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'additional_settings',
    '#attributes' => array(
      'class' => array('file-form-destination'),
    ),
    '#attached' => array(
      'js' => array(
        drupal_get_path('module', 'file_entity') . '/file_entity.js',
      ),
    ),
  );

  $options = array();
  foreach (file_get_stream_wrappers(STREAM_WRAPPERS_WRITE_VISIBLE) as $scheme => $info) {
    $options[$scheme] = check_plain($info['name']);
  }

  $form['destination']['scheme'] = array(
    '#type' => 'radios',
    '#title' => t('Destination'),
    '#options' => $options,
    // '#default_value' => file_uri_scheme($file->uri), .
  );

  // File user information for administrators/ .
  $form['user'] = array(
    '#type' => 'fieldset',
    '#access' => user_access('administer files'),
    '#title' => t('User information'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'additional_settings',
    '#attributes' => array(
      'class' => array('file-form-user'),
    ),
    '#attached' => array(
      'js' => array(
        drupal_get_path('module', 'file_entity') . '/file_entity.js',
        array(
          'type' => 'setting',
          'data' => array('anonymous' => variable_get('anonymous', t('Anonymous'))),
        ),
      ),
    ),
    '#weight' => 90,
  );
  $form['user']['name'] = array(
    '#type' => 'textfield',
    '#title' => t('Associated with'),
    '#maxlength' => 60,
    '#autocomplete_path' => 'user/autocomplete',
    '#weight' => -1,
    '#description' => t('Leave blank for %anonymous.', array('%anonymous' => variable_get('anonymous', t('Anonymous')))),
  );

  // Add the buttons.
  $form['actions'] = array('#type' => 'actions');
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
    '#weight' => 5,
    '#submit' => array('file_entity_edit_submit'),
  );
  $form['actions']['delete'] = array(
    '#type' => 'submit',
    '#value' => t('Delete'),
    '#weight' => 10,
    '#submit' => array('file_entity_edit_delete_submit'),
    // '#access' => file_entity_access('delete', $file), .
  );
  return $form;
*/
}

/**
 * Implements hook_entity_info_alter().
 *
 * Adds view modes to file entities.
 */
function imager_entity_info_alter(array &$entity_info) {
  $entity_info['media']['view modes']['media_imager_info'] = array(
    'label' => t('Imager Info'),
    'custom settings' => TRUE,
  );
  $entity_info['media']['view modes']['media_imager_map'] = array(
    'label' => t('Imager Map'),
    'custom settings' => TRUE,
  );
  return;
//$entity_info['file']['view modes']['media_imager_email'] = array(
//  'label' => t('Imager Email'),
//  'custom settings' => TRUE,
//);
//$entity_info['media']['view modes']['media_imager_browser'] = array(
//  'label' => t('Imager Browser'),
//  'custom settings' => TRUE,
//);
}

function imager_node_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
  return;
}

/**
 * Implements HOOK_node_view().
 *
 * @param array $build
 * @param \Drupal\Core\Entity\EntityInterface $entity
 * @param \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display
 * @param $view_mode
 */
function imager_node_view_alter(array &$build, Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display) {
  return;
}
/**
 * Implements HOOK_user_view_alter().
 *
 * @param array $build
 * @param \Drupal\Core\Entity\EntityInterface $entity
 * @param \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display
 * @param $view_mode
 */
function imager_user_view_alter(array &$build, UserInterface $account, EntityViewDisplayInterface $display) {
  return;
}
/**
 * Implements hook_file_view_alter().
 *
 * Add filename, owner, filesize, fid and image geometry to the file view.
 */
function imager_file_view_alter(array &$build, $type) {
/*
  // Exit if view_mode != configured view mode for information dialog.
  if ($build['#view_mode'] !== variable_get('imager_information_view_mode')) {
    return $build;
  }
  $file = $build['#file'];
  $geometry = $file->metadata['width'] . ' x ' . $geometry = $file->metadata['height'];

  if ($file->filesize > 1000000) {
    $filesize = (round($file->filesize / 100000) / 10) . ' MB';
  }
  else {
    $filesize = (round($file->filesize / 100) / 10) . ' KB';
  }

  if (isset($build['field_description'])) {
    $build['field_description']['#prefix'] = '<br>';
  }
  $build['sfield_filename'] = array(
    '#access' => 1,
    '#bundle' => 'image',
    '#entity_type' => 'file',
    '#field_name' => 'sfield_filename',
    '#field_type' => 'text',
    '#formatter' => 'text_default',
    '#items' => array('anything'),
    '#prefix' => '<br>',
    '#label_display' => 'inline',
    '#theme' => 'field',
    '#title' => 'File Name',
    '#optional' => TRUE,
    '#weight' => 20,
    0 => array(
      '#markup' => $file->filename,
    ),
  );
  $build['sfield_owner'] = array(
    '#access' => 1,
    '#bundle' => 'image',
    '#entity_type' => 'file',
    '#field_name' => 'sfield_owner',
    '#field_type' => 'text',
    '#formatter' => 'text_default',
    '#items' => array('anything'),
    '#label_display' => 'inline',
    '#theme' => 'field',
    '#title' => 'File Owner',
    '#optional' => TRUE,
    '#weight' => 21,
    0 => array(
      '#markup' => user_load($file->uid)->name,
    ),
  );
  $build['sfield_filesize'] = array(
    '#access' => 1,
    '#bundle' => 'image',
    '#entity_type' => 'file',
    '#field_name' => 'sfield_filesize',
    '#field_type' => 'text',
    '#formatter' => 'text_default',
    '#items' => array('anything'),
    '#label_display' => 'inline',
    '#theme' => 'field',
    '#title' => 'File Size',
    '#optional' => TRUE,
    '#weight' => 23,
    0 => array(
      '#markup' => $filesize,
    ),
  );
  $build['sfield_geometry'] = array(
    '#access' => 1,
    '#bundle' => 'image',
    '#entity_type' => 'file',
    '#field_name' => 'sfield_geometry',
    '#field_type' => 'text',
    '#formatter' => 'text_default',
    '#items' => array('anything'),
    '#label_display' => 'inline',
    '#theme' => 'field',
    '#title' => 'Geometry',
    '#optional' => TRUE,
    '#weight' => 24,
    0 => array(
      '#markup' => $geometry,
    ),
  );
  $build['sfield_fid'] = array(
    '#access' => 1,
    '#bundle' => 'image',
    '#entity_type' => 'file',
    '#field_name' => 'sfield_fid',
    '#field_type' => 'text',
    '#formatter' => 'text_default',
    '#items' => array('anything'),
    '#label_display' => 'inline',
    '#theme' => 'field',
    '#title' => 'File ID',
    '#optional' => TRUE,
    '#weight' => 25,
    0 => array(
      '#markup' => $file->fid,
    ),
  );
*/
}

/**
 * Check if a library variant has been installed.
 *
 * @param array $library
 *   Library info array.
 * @param string $variant
 *   Variant name.
 *
 * @return bool
 *   TRUE if the variant exists, FALSE otherwise.
 */
function imager_library_detect_variant(array $library, $variant) {
/*
  if (!empty($library['variants'][$variant]['files'])) {
    $files = $library['variants'][$variant]['files'];

    foreach (array('js', 'css') as $type) {
      if (!empty($files[$type])) {
        reset($files[$type]);
        return file_exists(DRUPAL_ROOT . '/' . $library['library path'] . '/' . key($files[$type]));
      }
    }
  }

  return FALSE;
*/
}


